##########################################################################################################################
##é¢„è¿›æ–™â€”â€”è€—æåœ¨æ–™æ¶ä¸ŠåŠ è½½è‡³åˆ†å‰å£ä½ç½®â€”â€”â€”â€”â†“â†“â†“â†“â†“â†“
##########################################################################################################################

# [gcode_macro yujinliao]
# description: å°†è€—æåŠ è½½è‡³é¢„å¤‡ä½ç½®ï¼ˆä»…åœ¨éä»»åŠ¡é˜¶æ®µä½¿ç”¨ï¼‰                              
# variable_tnum:0                                   
# #variable_feeding_state:1                         
# gcode:                                      
#     {% set state = printer['gcode_macro var']['state'] %}                                
#     {% set tnum = params.TNUM|default(0)|int %}                                                
#     {% set runout= printer['gcode_macro var']['runout'] %}	              
#     {% set cas = printer['filament_switch_sensor cas'~ tnum].filament_detected %}
#     {% set cbs = printer['filament_switch_sensor cbs'~ tnum].filament_detected %}
#     {action_respond_info("casé€šé“å¼€å…³çŠ¶æ€%d" % (cas))}    
#     {action_respond_info("cbsé€šé“å¼€å…³çŠ¶æ€%d" % (cbs))}            

#     G92 E0

#        {% if state == 0 and runout == 0 %}
#            {% if cas == 1 and cbs == 0 %}
#                wakemove WAKEMOVE={tnum}
#                G1 E{5} F{200}
#                G1 E{printer["gcode_macro var"].furcation_to_cbs+40} F{printer["gcode_macro var"].bspeed0}
#                get_Last_Extruder
#                SET_STEPPER_ENABLE STEPPER=extruder enable=0
#            {% endif %}
#        {% else %}
#            {% if cas == 1 and cbs == 0 %}                                                   ##å¦‚æœå…¥æ–™å£å¤„æ²¡æœ‰åŠ è½½è€—æ
#                {action_respond_info("é€šé“%dè€—æè¿œç¨‹é€æ–™è‡³åˆ†å‰å£ä½ç½®" % (tnum))}   
#                G1 E{5} F{200}
#                G1 E{printer["gcode_macro var"].furcation_to_cbs} F{printer["gcode_macro var"].bspeed0}
#            {% elif cas == 0 and cbs == 0 %}
#                {action_respond_info("é€šé“%dç¼ºæ–™,è¯·ç¡®è®¤å·²ç»æ”¾ç½®è€—æ" % (tnum))}
#            {% elif cas == 0 and cbs == 1 %}
#                 {action_respond_info("é€šé“%dè€—æå·²ç»ä¸è¶³,è¯·åŠæ—¶åŠ æ–™" % (tnum))}
#                 {action_respond_info("è‹¥é€šé“%då­˜åœ¨è€—æ,è¯·æ£€æŸ¥æˆ–æ›´æ¢å¾®åŠ¨å¼€å…³" % (tnum))}
#            {% else %}
#                 {action_respond_info("é€šé“%dè€—æé½å¤‡" % (tnum))}
#            {% endif %}
#        {% endif %}

[gcode_macro yujinliao]
description:å°†è€—æåŠ è½½è‡³é¢„å¤‡ä½ç½®ï¼ˆä»…åœ¨éä»»åŠ¡é˜¶æ®µä½¿ç”¨ï¼‰					                           ##ä¸­æ–‡æ³¨é‡Š
gcode:  
        {% set state= printer['gcode_macro var']['state'] %}				                   ##è·å–varä¸­çš„stateï¼ˆå¤„äºæ‰“å°ä»»åŠ¡æ—¶state=1ï¼Œæœªå¤„äºæ‰“å°ä»»åŠ¡æ—¶state=0ï¼‰é»˜è®¤ä¸º0
        {% set yujinliao = params.YUJINLIAO|default(0)|int %}                                  ##è·å–éœ€è¦å”¤é†’çš„t{num}æŒ¤å‡ºæœº
        {% set svv = printer.save_variables.variables %}                                       ###è·å–æ–­ç”µæ—¶å€™çš„è€—æçš„åºå· â€œ0ã€1ã€2ã€3â€
        {% set svvc = svv.currentextruder %}                                                   #å˜é‡åé•¿åº¦ä¼˜åŒ–.
        {% set cas = printer['filament_switch_sensor cas'~ svvc].filament_detected %}
        {% set cbs = printer['filament_switch_sensor cbs'~ svvc].filament_detected %}	
        {% set inout = printer['filament_switch_sensor INOUT'].filament_detected %}         ##inoutçŠ¶æ€ï¼Œåˆ¤æ–­è€—ææ˜¯å¦åŠ è½½è‡³å–·å¤´å¤„
        
        {% if state == 0 %} 
        moveout                                                                                ##ä¸­æ–­/åˆå§‹åŒ–æ‰€æœ‰çš„è¿œç¨‹é€æ–™ç”µæœº
        breakout                                                                               ##è®©è¿›ç¨‹æŒ¤å‡ºæœºåœæ­¢å·¥ä½œ 
        SYNC_EXTRUDER_MOTION EXTRUDER=t{yujinliao} MOTION_QUEUE=extruder
        G92 E0                                                                                 ##é‡ç½®å½“å‰æŒ¤å‡ºæœºåæ ‡
  	 	G1 E{printer["gcode_macro var"].readyin} F{printer["gcode_macro var"].readyinspeed}	   ##t0æŒ¤å‡ºæœºä»¥s0çš„è·ç¦»ï¼Œspeed0çš„é€Ÿåº¦å·¥ä½œ
        G4 P200                                                                                ##ç•™ç»™æ–­æ–™æ£€æµ‹ä¼ æ„Ÿå™¨çš„æ£€æµ‹å»¶è¿Ÿ
               
              {% if cas == 1 %}                                                                ##ä¸­æ–­/åˆå§‹åŒ–æ‰€æœ‰çš„è¿œç¨‹é€æ–™ç”µæœº
                    {% if cbs == 1 %}                                                          ##ä¸­æ–­/åˆå§‹åŒ–æ‰€æœ‰çš„è¿œç¨‹é€æ–™ç”µæœº
                         {% if inout == 1 %} 
                            WAKEUP WAKEUP={svvc}
                            {action_respond_info(" %då·ä½è€—æå·²å¯ç”¨ï¼Œå¯éšæ—¶å¼€å§‹æ‰“å°ğŸ˜Š" % (svvc))}  ##æ˜¾ç¤ºæ–‡æœ¬
                            {% else %}
                            {action_respond_info(" %då·ä½è€—æå¯èƒ½ä½äºæ‰“å°æœºä¸KMSä¸­éƒ¨ä½ç½®âš " % (svvc))}  ##æ˜¾ç¤ºæ–‡æœ¬
                            moveout
                            {% endif %}
                    {% else %}
                         moveout
                    {% endif %}
                {% else %}
                moveout
              {% endif %}                                                            
        {% endif %}